#!/usr/bin/env ruby

require File.expand_path(File.join(File.dirname(__FILE__), '..', 'lib', 'common'))
require 'trollop'
require_all_files_in_folder 'tours'

opts = Trollop.options do
  opt :host, "Remote hostname to test", :default => "localhost:3000"
  opt :concurrency, "Number of simultaneous runs to perform", :type => :integer, :default => 1
  opt :number, "Number of times to run the tour (in each concurrent step, so -c 10 -n 10 will run the tour 100 times)", :type => :integer, :default => 1
  opt :verbose, "Run in verbose mode", :type => :boolean, :default => false
  opt :list, "List tours and runs available. If tours or runs are included, filters the list", :type => :boolean, :default => nil
  opt :rand, "Random seed", :type => :integer, :default => nil
end

tours = if ARGV.empty?
           Dir[File.join('.', 'tours', '*.rb')].map {|f| File.basename(f, ".rb")}
         else
           ARGV
         end

srand opts[:rand] || Time.now.to_i

if opts[:list]
  Tour.tours(ARGV).each do |tour|
    puts tour
    puts Tour.tests(tour).map {|test| "  #{test}"}
  end
else
  puts TourBus.new(opts[:host], opts[:concurrency], opts[:number], tours).run
end

